<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grace's Book Club</title>

<link rel="icon" href="https://drive.google.com/file/d/1wTpKGRyyPZ4pDU13rmkcx6kfugDEB0bj/view?usp=sharing" type="image/x-icon">
<link rel="icon" href="https://drive.google.com/file/d/1wumFBEoSMXZsdHhkcUhdg1dYNuB3a0qx/view?usp=sharing" type="image/png">

<style>
html, body {
  margin: 0;
  font-family: "Times New Roman", Times, serif;
  background-color: #fff5f8;
}

/* Wine-colored links for Suggested Books table */
.suggested-books-table a {
  color: #7a0c26;
  text-decoration: none;
  font-weight: 500;
}
.suggested-books-table a:hover { text-decoration: underline; }

/* Disabled button style */
.submit-btn:disabled,
.submit-btn.disabled {
  background-color: #aaa !important;
  color: #666 !important;
  cursor: not-allowed !important;
  box-shadow: none !important;
  opacity: 0.85;
}
.submit-btn:not(:disabled):hover { transform: translateY(-1px); }

/* Navigation bar */
.nav-bar {
  display: flex;
  justify-content: center;
  background-color: #eec2cd;
  padding: 12px 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.nav-bar button {
  margin: 0 8px;
  padding: 12px 26px;
  font-size: 1em;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: all 0.18s;
  background-color: #eec2cd;
  color: black;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.nav-bar button:hover {
  background-color: #4c1033;
  color: white;
}

/* Containers */
.container {
  background: white;
  padding: 25px 30px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  text-align: center;
  width: 90%;
  max-width: 700px;
  margin: 30px auto;
  display: none;
}
.container.active { display: block; }

h2 { color: #4c1033; font-size: 30pt; margin-bottom: 10px; }

.note { font-size: 11pt; color: #666; margin-top: 6px; }

/* Inputs & selects match width */
input, select {
  width: 100%;
  box-sizing: border-box;
  padding: 8px 10px;
  margin: 6px 0;
  font-size: 12pt;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  font-family: "Times New Roman", Times, serif;
}

button.submit-btn {
  margin-top: 12px;
  margin-bottom: 16px;
  background-color: #eec2cd;
  color: black;
  border: none;
  cursor: pointer;
  transition: all 0.18s;
  padding: 12px 26px;
  font-size: 1.05em;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
button.submit-btn:hover {
  background-color: #4c1033;
  color: white;
}

.divider {
  width: 50%;
  height: 1px;
  background: #e6e6e6;
  margin: 12px auto 10px;
  border-radius: 2px;
}

/* Tables */
table {
  margin: 18px auto;
  border-collapse: separate;
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  width: 100%;
  table-layout: fixed;
  word-wrap: break-word;
}
th {
  background-color: #4c1033;
  color: white;
  font-weight: bold;
  font-size: 14pt;
  text-align: left;
  padding: 10px 12px;
}
th:first-child { border-top-left-radius:6px; }
th:last-child { border-top-right-radius:6px; }
td {
  padding: 8px 12px;
  vertical-align: middle;
  font-size: 12pt;
  text-align: left;
  word-wrap: break-word;
}
tbody tr:nth-child(even) { background: #f2f2f2; }
tbody tr:nth-child(odd) { background: white; }
tbody tr:hover { background: #ffe6eb; }

/* Stars for rating */
.stars { display: flex; flex-direction: row-reverse; justify-content: center; margin-top: 10px; }
.stars input { display: none; }
.stars label {
  font-size: 3em;
  color: #ccc;
  cursor: pointer;
  transition: transform 0.2s, color 0.2s;
  user-select: none;
}
.stars input:checked ~ label,
.stars label:hover,
.stars label:hover ~ label {
  color: gold;
  transform: scale(1.2);
}

/* Suggested books table column widths */
.suggested-books-table th:nth-child(1),
.suggested-books-table td:nth-child(1) { width: 70%; }
.suggested-books-table th:nth-child(2),
.suggested-books-table td:nth-child(2),
.suggested-books-table th:nth-child(3),
.suggested-books-table td:nth-child(3) { width: 30%; text-align: center; }

/* Vote buttons */
.suggested-books-table button.vote-btn {
  background-color: #eec2cd;
  color: black;
  border: none;
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 6px;
  font-size: 0.95rem;
  font-family: "Times New Roman", Times, serif;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.suggested-books-table button.vote-btn:hover { background-color: #4c1033; color: white; }
.suggested-books-table button.vote-btn:disabled { background-color: #ccc; cursor: not-allowed; color: #666; }

/* Responsive tweaks */
@media (max-width: 700px) {
  h2 { font-size: 24pt; }
  input, select, button.submit-btn { font-size: 11pt; padding: 8px 16px; }
  table, th, td { font-size: 11pt; }
}

/* Past Books Carousel */
.past-books-section.container { width: 90%; max-width: 900px; margin: 30px auto; }
.past-books-section h2 { margin: 0 0 14px 0; font-size: 26pt; color: #4c1033; text-align: center; }
.carousel { display: flex; align-items: center; gap: 12px; }
.carousel-track-wrapper { overflow: hidden; flex: 1 1 auto; border-radius: 12px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
.carousel-track { display: flex; padding: 0; margin: 0; list-style: none; transition: transform 0.45s cubic-bezier(.25,.8,.25,1); }
.carousel-slide { aspect-ratio: 1/1; width: 260px; max-width: 32vw; flex: 0 0 auto; display: flex; align-items: stretch; justify-content: center; background: white; border-radius: 8px; overflow: hidden; }
.carousel-slide img { width: 100%; height: 100%; object-fit: contain; object-position: center; display: block; background: #fff; border-top-left-radius: 8px; border-top-right-radius: 8px; }
.carousel-caption { padding: 12px; text-align: left; font-size: 1rem; color: #4c1033; background: white; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
.carousel-caption a.title-link { color: #4c1033; text-decoration: none; font-weight: 600; }
.carousel-caption a.title-link:hover { text-decoration: underline; }
.carousel-caption .month { display: block; margin-top: 6px; font-size: 0.95rem; color: #666; }
.carousel-btn { background: #eec2cd; border: none; color: black; padding: 10px 12px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
.carousel-btn:hover { background: #4c1033; color: white; }
.carousel-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.small-btn { background: transparent; border: 1px solid #eec2cd; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-family: "Times New Roman", Times, serif; }
.small-btn:hover { background: #eec2cd; }
@media (max-width: 700px) {
  .carousel-slide { width: 210px; max-width: 60vw; aspect-ratio: 1/1; }
  .carousel-slide img { height: 220px; }
  .past-books-section h2 { font-size: 20pt; }
}
</style>
</head>
<body>

<div class="nav-bar">
  <button data-target="past-books">Home</button>
  <button data-target="rsvp">RSVP</button>
  <button data-target="suggest">Suggest & Vote</button>
  <button data-target="rate">Rate Our Books</button>
</div>

<section id="past-books" class="past-books-section container active">
  <h2>Past Books</h2>
  <div class="carousel" aria-roledescription="carousel">
    <button class="carousel-btn prev" aria-label="Previous book">◀</button>
    <div class="carousel-track-wrapper">
      <ul class="carousel-track" aria-live="polite"></ul>
    </div>
    <button class="carousel-btn next" aria-label="Next book">▶</button>
  </div>
  <div class="carousel-controls">
    <button id="carousel-play" class="small-btn" aria-pressed="false">Play</button>
    <button id="carousel-pause" class="small-btn" aria-pressed="true" style="display:none">Pause</button>
  </div>
</section>

<div id="rsvp" class="container">
  <h2>RSVP</h2>
  <form id="rsvpForm">
    <input type="text" name="name" placeholder="Your name" required><br>
    <input type="text" name="bringing" placeholder="What are you bringing?" required><br>
    <button type="submit" class="submit-btn">Submit</button>
  </form>
  <div class="divider"></div>
  <p id="meeting-date" class="note"></p>
  <p id="meeting-theme" class="note"></p>
  <table id="rsvp-table">
    <thead>
      <tr><th>Name</th><th>Bringing</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="suggest" class="container">
  <h2>Suggest a Book</h2>
  <form id="nomForm" novalidate>
    <input id="title" name="title" type="text" placeholder="Title" required><br>
    <input id="link" name="link" type="url" placeholder="Goodreads link (must start with http:// or https://)" required><br>
    <button id="submitBtn" type="submit" class="submit-btn">Submit</button>
    <div id="nomStatus" class="note" aria-live="polite"></div>
  </form>

  <div class="divider"></div>
  <h2>Suggested Books</h2>
  <p id="voteNotice" class="note">You have <span id="votesLeft">3</span> votes remaining.</p>
  <table id="nomsTable" aria-live="polite" class="suggested-books-table">
    <thead>
      <tr><th>Title</th><th colspan="2"></th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="rate" class="container">
  <h2>Rate Our Books</h2>
  <form id="ratingForm">
    <label for="book">Select Book:</label>
    <select id="book" name="book"></select>
    <label>Rating:</label>
    <div class="stars">
      <input type="radio" id="star5" name="rating" value="5"><label for="star5">&#9733;</label>
      <input type="radio" id="star4" name="rating" value="4"><label for="star4">&#9733;</label>
      <input type="radio" id="star3" name="rating" value="3"><label for="star3">&#9733;</label>
      <input type="radio" id="star2" name="rating" value="2"><label for="star2">&#9733;</label>
      <input type="radio" id="star1" name="rating" value="1"><label for="star1">&#9733;</label>
    </div>
    <button type="submit" class="submit-btn">Submit</button>
  </form>
  <div id="status" class="note"></div>
  <div id="averages">
    <table>
      <thead><tr><th>Book</th><th>Average Rating</th><th>Number of Ratings</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
// ===== Navigation =====
const navButtons = document.querySelectorAll('.nav-bar button');
const containers = document.querySelectorAll('.container');
navButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const target = btn.dataset.target;
    containers.forEach(c => c.classList.remove('active'));
    document.getElementById(target)?.classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
});

// ===== RSVP =====
const rsvpForm = document.getElementById('rsvpForm');
const rsvpTableBody = document.querySelector('#rsvp-table tbody');
const meetingDate = document.getElementById('meeting-date');
const meetingTheme = document.getElementById('meeting-theme');

async function loadRSVPs() {
  try {
    const data = await fetch('/.netlify/functions/getRSVPs').then(r => r.json());
    rsvpTableBody.innerHTML = '';
    data.reverse().forEach(entry => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${entry.name}</td><td>${entry.bringing}</td>`;
      rsvpTableBody.appendChild(row);
    });
  } catch(e){ console.error(e); }
}

async function loadMeetingInfo() {
  try {
    const info = await fetch('/.netlify/functions/getMeetingInfo').then(r=>r.json());
    meetingDate.textContent = `Date: ${info.date}`;
    meetingTheme.textContent = `Theme: ${info.theme}`;
  } catch(e){ console.error(e); }
}

loadRSVPs(); loadMeetingInfo();
setInterval(()=>{loadRSVPs(); loadMeetingInfo();},5000);

rsvpForm.addEventListener('submit', async e => {
  e.preventDefault();
  const name = rsvpForm.name.value.trim();
  const bringing = rsvpForm.bringing.value.trim();
  if(!name||!bringing) return;
  try {
    await fetch('/.netlify/functions/addRSVP',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,bringing})});
    rsvpForm.reset(); loadRSVPs();
  } catch(err){ console.error(err); }
});

// ===== Suggest & Vote =====
const nomForm = document.getElementById('nomForm');
const nomStatus = document.getElementById('nomStatus');
const nomsBody = document.querySelector('#nomsTable tbody');
const submitBtn = document.getElementById('submitBtn');
const votesLeftSpan = document.getElementById('votesLeft');
const MAX_VOTES = 3;
if(!sessionStorage.getItem('votesCast')) sessionStorage.setItem('votesCast','0');
function getVotesLeft(){ return MAX_VOTES-parseInt(sessionStorage.getItem('votesCast')||'0',10); }
function updateVotesLeftDisplay(){ votesLeftSpan.textContent=getVotesLeft(); }
function setButtonDisabledVisual(btn, disabled){ btn.disabled=!!disabled; if(disabled){btn.classList.add('disabled'); btn.setAttribute('aria-disabled','true');} else{btn.classList.remove('disabled'); btn.removeAttribute('aria-disabled');} }
function updateVoteButtonsState(){ document.querySelectorAll('#nomsTable button[data-nom-id]').forEach(b=>setButtonDisabledVisual(b,getVotesLeft()<=0)); }
updateVotesLeftDisplay();

// URL validation
function validUrl(u){try{const url=new URL(u);return url.protocol==='http:'||url.protocol==='https:';}catch(e){return false;}}

// Load nominations
async function loadNoms(){
  try{
    const data = await fetch('/.netlify/functions/getNominations').then(r=>{if(!r.ok)throw new Error('Network error');return r.json();});
    nomsBody.innerHTML='';
    data.forEach((nom,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><a href="${nom.link}" target="_blank" rel="noopener">${nom.title}</a></td>
                     <td>${nom.votes}</td>
                     <td><button data-nom-id="${idx}" class="vote-btn">Vote</button></td>`;
      nomsBody.appendChild(tr);
    });
    updateVoteButtonsState();
  }catch(e){console.error(e);}
}
loadNoms();
setInterval(loadNoms,5000);

nomForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const title=nomForm.title.value.trim();
  const link=nomForm.link.value.trim();
  if(!title||!validUrl(link)){ nomStatus.textContent='Please enter a valid title and URL'; return; }
  try{
    await fetch('/.netlify/functions/addNom',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,link})});
    nomForm.reset(); nomStatus.textContent='Nomination submitted!'; loadNoms();
  }catch(err){ console.error(err); nomStatus.textContent='Error submitting.';}
});

// Voting
nomsBody.addEventListener('click',async e=>{
  if(!e.target.matches('button[data-nom-id]')) return;
  const votesLeft = getVotesLeft();
  if(votesLeft<=0) return;
  const idx = e.target.dataset.nomId;
  try{
    await fetch('/.netlify/functions/vote',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({idx})});
    sessionStorage.setItem('votesCast', (parseInt(sessionStorage.getItem('votesCast')||'0',10)+1).toString());
    updateVotesLeftDisplay(); loadNoms();
  }catch(err){ console.error(err);}
});

// ===== Rate =====
const ratingForm = document.getElementById('ratingForm');
const bookSelect = document.getElementById('book');
const avgTableBody = document.querySelector('#averages tbody');
async function loadBooks(){ try{
  const data = await fetch('/.netlify/functions/getPastBooks').then(r=>r.json());
  bookSelect.innerHTML='';
  data.forEach(b=>{ const opt=document.createElement('option'); opt.value=b.title; opt.textContent=b.title; bookSelect.appendChild(opt); });
} catch(e){console.error(e);} }
async function loadAverages(){ try{
  const data = await fetch('/.netlify/functions/getRatings').then(r=>r.json());
  avgTableBody.innerHTML='';
  data.forEach(d=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${d.book}</td><td>${d.average}</td><td>${d.count}</td>`; avgTableBody.appendChild(tr); });
} catch(e){console.error(e);} }
loadBooks(); loadAverages();
setInterval(()=>{ loadBooks(); loadAverages(); },5000);
ratingForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const book=bookSelect.value;
  const rating=parseInt(ratingForm.rating.value,10);
  if(!book||!rating) return;
  try{
    await fetch('/.netlify/functions/addRating',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({book,rating})});
    ratingForm.reset(); loadAverages();
  }catch(err){ console.error(err);}
});

// ===== Past Books Carousel =====
(async function initPastBooksCarousel(){
  const track = document.querySelector('.carousel-track');
  const prevBtn = document.querySelector('.carousel-btn.prev');
  const nextBtn = document.querySelector('.carousel-btn.next');
  const playBtn = document.getElementById('carousel-play');
  const pauseBtn = document.getElementById('carousel-pause');
  if(!track) return;
  const PLACEHOLDER = '/favicon.ico';
  let items=[];
  try{ items = await fetch('/.netlify/functions/getPastBooks').then(r=>r.json()); }catch(err){ console.error(err); track.innerHTML='<li>Could not load past books.</li>'; return; }
  if(!items.length){ track.innerHTML='<li>No past books yet.</li>'; return; }

  items.forEach((it,idx)=>{
    const li=document.createElement('li'); li.className='carousel-slide'; li.dataset.index=idx;
    const imgWrap=document.createElement('a'); imgWrap.href=it.link||'#'; imgWrap.target='_blank'; imgWrap.rel='noopener';
    const img=document.createElement('img'); img.src=it.picture||PLACEHOLDER; img.alt=it.title||'Book cover'; imgWrap.appendChild(img);
    const caption=document.createElement('div'); caption.className='carousel-caption';
    const titleLink=document.createElement('a'); titleLink.className='title-link'; titleLink.href=it.link||'#'; titleLink.target='_blank'; titleLink.rel='noopener'; titleLink.textContent=it.title||'(no title)';
    caption.appendChild(titleLink);
    if(it.month){ const monthSpan=document.createElement('span'); monthSpan.className='month'; monthSpan.textContent=it.month; caption.appendChild(monthSpan);}
    li.appendChild(imgWrap); li.appendChild(caption); track.appendChild(li);
  });

  let slideIndex=0;
  const slides=Array.from(track.children);
  function updateTrackPosition(){ const wrapper=track.parentElement; const wrapperWidth=wrapper.getBoundingClientRect().width; const offset=slideIndex*wrapperWidth; track.style.transform=`translateX(-${offset}px)`; prevBtn.disabled=(slideIndex===0); nextBtn.disabled=(slideIndex>=slides.length-1); }
  function nextSlide(){ slideIndex=(slideIndex<slides.length-1)?slideIndex+1:0; updateTrackPosition(); }
  function prevSlide(){ slideIndex=(slideIndex>0)?slideIndex-1:slides.length-1; updateTrackPosition(); }
  prevBtn.addEventListener('click',prevSlide); nextBtn.addEventListener('click',nextSlide);
  document.addEventListener('keydown',e=>{ if(e.key==='ArrowLeft') prevSlide(); if(e.key==='ArrowRight') nextSlide(); if(e.key===' '||e.key==='Spacebar'){ e.preventDefault(); toggleAutoplay(); } });
  let autoplay=false, timer=null; const INTERVAL=5000;
  function startAutoplay(){ if(timer) clearInterval(timer); timer=setInterval(nextSlide,INTERVAL); autoplay=true; playBtn.style.display='none'; pauseBtn.style.display=''; playBtn.setAttribute('aria-pressed','true'); pauseBtn.setAttribute('aria-pressed','false'); }
  function stopAutoplay(){ if(timer) clearInterval(timer); timer=null; autoplay=false; playBtn.style.display=''; pauseBtn.style.display='none'; playBtn.setAttribute('aria-pressed','false'); pauseBtn.setAttribute('aria-pressed','true'); }
  function toggleAutoplay(){ autoplay?stopAutoplay():startAutoplay(); }
  playBtn.addEventListener('click',startAutoplay); pauseBtn.addEventListener('click',stopAutoplay);

  let imagesLoaded=0;
  slides.forEach(slide=>{
    const img=slide.querySelector('img'); if(!img){ imagesLoaded++; return; }
    if(img.complete){ imagesLoaded++; if(imagesLoaded===slides.length) updateTrackPosition(); }
    else{ img.addEventListener('load',()=>{ imagesLoaded++; if(imagesLoaded===slides.length) updateTrackPosition(); }); img.addEventListener('error',()=>{ imagesLoaded++; if(imagesLoaded===slides.length) updateTrackPosition(); }); }
  });
  startAutoplay();
})();
</script>

</body>
</html>
